name: Build Release Assets (cargo-dist)

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*" # Триггер на любой тег версии vX.Y.Z

jobs:
  build-release:
    name: Build Windows Assets
    # Мы должны использовать 'windows-latest' для сборки 'msvc' таргета
    runs-on: windows-latest
    
    permissions:
      # 'contents: write' нужно, чтобы 'cargo-dist' мог загрузить
      # артефакты (zip, msi, ps1) в GitHub Release.
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        # 'windows-latest' уже включает MSVC, так что таргет указывать не нужно

      - name: Install cargo-dist
        run: |
          # Используем PowerShell для установки cargo-dist на Windows
          powershell -c "irm https://github.com/axodotdev/cargo-dist/releases/latest/download/cargo-dist-installer.ps1 | iex"
      
      - name: Run cargo-dist build
        # 'cargo dist build' найдет тег, прочитает Cargo.toml
        # и соберет все артефакты для 'x86_64-pc-windows-msvc'
        run: cargo dist build
        env:
          # GITHUB_TOKEN нужен, чтобы cargo-dist нашел правильный URL релиза
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run cargo-dist upload
        # 'cargo dist upload' возьмет артефакты из 'target/dist'
        # и загрузит их в GitHub Release, созданный release-plz.
        run: cargo dist upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}